<!DOCTYPE html>
<html>
    <head>
        <title>XHR Cross Origin Proxy</title>
    </head>
    <body>
        <script>
            "use strict";
            window.onmessage = function (msg) {
                if (msg.source === window.parent && location.hostname === msg.origin.split(":")[1].substr(2)) { // "http://example.com:8888" => "example.com"
                    var data = JSON.parse(msg.data);
                    var id = data.id;
                    var request = data.request;
                    var xhr = new XMLHttpRequest();

                    xhr.open(request.method || 'GET', request.url, true);
                    Object.keys(request.headers || {}).forEach(function (key) {
                        xhr.setRequestHeader(key, request.headers[key]);
                    });

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === xhr.DONE) {
                            var headers = {};
                            var htext = xhr.getAllResponseHeaders();
                            htext.split(/\r?\n/).forEach(function (line) { // Some servers use "\n" and some use "\r\n".
                                var m = /^([^\s]*)\s*:\s*(.*)/.exec(line);
                                if (m) {
                                    headers[m[1].toLowerCase()] = m[2];
                                }
                            });
                            var response = { status: xhr.status, body: xhr.responseText, headers: headers };
                            var data = JSON.stringify({ type: "XCOP-RESPONSE", id: id, response: response });
                            msg.source.postMessage(data, msg.origin);
                        }
                    };
                    xhr.send(request.body);
                }
            };
            window.parent.postMessage(JSON.stringify({type: "XCOP-READY" }), "*");
        </script>
    </body>
</html>
